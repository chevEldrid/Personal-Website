<!Doctype HTML>
  <head>
    <meta cbarset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.css">
      <!--  -->
      <title>Planechase</title>
      <style type="text/css">
        /*Universal Properties*/
        body {
          background-color: black;
          color: white;
        }
        
        .modal {
          color: black;
        }
        
        #Plane-image {
          height: 65%;
          width: 65%;
          transform:  rotate(90deg) translateX(-25%) translateY(20%);
          margin: 0 0 0 0;
        }
        
        #Plane-image-imgur {
          height: 70%;
          width: 70%;
          margin: 0 0 0 0;
        }
        
        .rotation-correction {
          transform: translateY(-100px);
        }
        
        .minimized {
          height: 35%;
          width: 35%;
        }
          
        
        @media (min-device-width: 701px) {
          #Plane-image {
            height: 50%;
            width: 50%;
            transform:  rotate(90deg) translateX(-25%) translateY(25%);
            margin: 0 0 0 0;
          }
          
          #Plane-iamge-imgur {
            height: 65%;
            width: 65%;
            margin: 0 0 0 0;
          }
          
          .rotation-correction {
            transform: translateY(-200px);
          }
            
           .minimized {
            height: 5%;
            width: 5%;
          }
        }
        
      </style>
  </head>
  <body onload="loadDoc()">
    <main role="main" class="container">
      <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
          <div class="text-center">
            <img align="right" class="img-fluid mx-auto d-block" id="Plane-image" />
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
          <div id="Button-row" class="text-center mobile-view">
            <button type="button" class="btn btn-light" onclick="prevPlane()">Return</button>
            <button type="button" class="btn btn-light" onclick="nextPlane()">Advance</button>
            <button type="button" class="btn btn-light" onclick="rollDie()">Roll</button>
            <button type="button" class="btn btn-light" onclick="loadPlaneList()" data-toggle="modal" data-target="#exampleModal">
              Settings
            </button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
          <div class="text-center">
            <p id="Credit"></p>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
          <div class="text-center mobile-view mobile-counter">
            <h1 id="Chaos-roll"></h1>
          </div>
        </div>
      </div>
      
      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Planechase Settings</h5>
              <button type="button" class="close" data-dismiss="modal" onclick="clearList()" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Deck Source
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="dropdown-item" href="#" onclick="loadDoc()">Default</a>
                  <a class="dropdown-item" href="#" onclick="load2019()">Planechase 2019</a>
                </div>
              </div>
              <p>Filter Planelist</p>
              <ul id="Planelist"></ul>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="resetDeck()">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" ></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script>
      //global variables
      //stores total list of cards from set
      var cards;
      //stores total list of cards filtered from set
      var filteredCards;
      //stores current deck index
      var index;
      //keeps track of times nothing is rolled to show players
      var nothingCount = 0;
      //current deck source: 0=official, 1=imgur
      var deckSource = 0;
      //api credentials for imgur
      var imgurClientID = "6d9d9566773c008";
      //current image-id
      var curImageID = "Plane-image";
      //sets up default deck of planes, official ones
      function loadDoc() {
        clearList();
        deckSource = 0;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var response = JSON.parse(this.responseText);
            cards = response.data;
            index = 0;
            cards = shuffle(cards);
            //store copy users will manipulate
            filteredCards = cards;
            updateImageFields("Plane-image", "right");
            toggleCorrection();
            document.getElementById("Credit").Text="";
            var credit = document.getElementById("Credit")
            while(credit.hasChildNodes()) {
              credit.removeChild(credit.childNodes[0]);
            }
          }
        };
        xhttp.open("GET", "https://api.scryfall.com/cards/search?q=t%3Aphenomenon+OR+t%3Aplane", true);
        xhttp.send();
      };
      
      function load2019() {
        var toDelete = new Array(2,3,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,32,34,36,51,55,62,68,69)
        loadImgurDeck("7XIjH4t", toDelete);
      };
      
      //gets rid of things at particular indeces i.e. non-planes
      function filterIndecies(toRemove, toRemoveFrom) {
        var e;
        var f;
        var tempCards = new Array();
        for(e = 0; e < toRemoveFrom.length; e++) {
          var found = false;
          for( f = 0; f<toRemove.length; f++) {
            if(e === toRemove[f] ){
              found = true;
              break;
            }
          }
          if(!found) {
            tempCards.push(toRemoveFrom[e]);
          }
        }
        return tempCards;
      };
      
      //given an album code from imgur, loads imgur album --experimental
      function loadImgurDeck(albumCode, toRemove) {
        clearList();
        deckSource = 1;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var response = JSON.parse(this.responseText);
            cards = response.data;
            cards = cards.images;
            filteredCards = filterIndecies(toRemove, cards);
            index = 0;
            filteredCards = shuffle(filteredCards);
            updateImageFields("Plane-iamge-imgur", "center");
            toggleCorrection();
            var node = document.createTextNode("Created by Imgur user: Blithium");
            document.getElementById("Credit").appendChild(node);
          }
        };
        var url = ("https://api.imgur.com/3/album/" + albumCode);
        xhttp.open("GET", url, true);
        var authValue = ("Client-ID "+imgurClientID);
        xhttp.setRequestHeader("Authorization", authValue);
        xhttp.send();
      };
      
      //updates necessary fields of image with new ID
      //sets src to first img in list
      function updateImageFields(imageID, alignment) {
        var image = document.getElementById(curImageID);
        image.id = imageID;
        curImageID = imageID;
        image.src = getImage(index);
        image.align = alignment;
      };
      
      //because need to move everything around when rotate scryfall
      function toggleCorrection() {
        document.getElementById("Button-row").classList.toggle("rotation-correction");
        document.getElementById("Chaos-roll").classList.toggle("rotation-correction");
      };
      
      //returns image @ given index based on deckSource
      //0 = official list from scryfall
      //1 = imgur album
      function getImage(ind){
        if(deckSource === 0){
          return filteredCards[ind].image_uris.normal;
        }
        else if(deckSource === 1) {
          return filteredCards[ind].link;
        }
      };
      
    //separate for use later: shuffle method
    function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;
        // While there remain elements to shuffle...
        while (0 !== currentIndex) {
          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;
          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
      return array;
    };
    //resets deck (after a filter change)
    function resetDeck() {
      shuffle(filteredCards);
      index = 0;
      var picture = document.getElementById(curImageID);
      picture.src = getImage(index);
      var planes = document.getElementById("Planelist")
      while(planes.hasChildNodes()) {
        planes.removeChild(planes.childNodes[0]);
      }
    };
    
    //just clears the modal list
    function clearList() {
      var planes = document.getElementById("Planelist")
      while(planes.hasChildNodes()) {
        planes.removeChild(planes.childNodes[0]);
      }
    };
    
    //returns the image of the next plane in sequence
    function nextPlane() {
        if(index < filteredCards.length - 1 ) {
          index++;
        }
        else {
          index = 0;
        }
        //getImage(index);
        document.getElementById(curImageID).src = getImage(index);
      };
      
    //returns previous plane in sequence
    function prevPlane() {
      if(index > 0) {
        index--;
      }
      //getImage(index);
      document.getElementById(curImageID).src = getImage(index);
    };
    //returns either a number or Chaos
    function rollDie() {
      var result;
      randomIndex = Math.floor(Math.random()* 6);
      randomIndex++;
      if(randomIndex == 6) {
        //result = "Chaos";
        result = "<img class='minimized' src='chaos.png' />";
        nothingCount = 0;
      }
      else if(randomIndex == 1) {
        //result = "Planeswalk";
        result = "<img class='minimized' src='walker.png' />";
        nothingCount = 0;
        nextPlane();
      }
      else {
        nothingCount ++;
        result = ("Nothing x" + nothingCount);
        
      }
      document.getElementById("Chaos-roll").innerHTML = (result);
    };
    //loads a list of all available planes and styles according to inclusion in filteredCards
    function loadPlaneList() {
      clearList();
      var i;
      var j;
      var planeList = document.getElementById("Planelist");
      if(deckSource === 0){
        for (i = 0; i < cards.length; i++) {
          var li=document.createElement("li");
          var found = false;
          for (j = 0; j < filteredCards.length; j++) {
            if(cards[i].name === filteredCards[j].name)
            {
              found = true;
              var button = document.createElement('button');
              button.innerHTML = 'Remove';
              button.onclick = removePlane;
              button.classList.add("btn");
              button.classList.add("btn-danger");
              button.value = i+"";
              li.appendChild(button);
              break;
            }
          }
          
          if(!found) {
            var button = document.createElement('button');
              button.innerHTML = 'Add';
              button.onclick = addPlane;
              button.classList.add("btn");
              button.classList.add("btn-success");
              button.value = i+"";
              li.appendChild(button);
          }
          
          li.appendChild(document.createTextNode("  "+cards[i].name));
          planeList.appendChild(li);
        }
      }
      else if(deckSource === 1){
        var text = document.createElement('p');
        text.appendChild(document.createTextNode("Feature unavailable for Imgur"));
        planeList.appendChild(text);
      }
    };
    
    //removes plane from filteredPlane list
    function removePlane() {
      var cardIndex = parseInt(this.value);
      var cardsTemp = [];
      var cardName = cards[cardIndex].name;
      this.innerHTML = 'Add';
      this.onclick = addPlane;
      this.classList.remove("btn-danger");
      this.classList.add("btn-success");
      var x;
      for(x = 0; x < filteredCards.length; x++) {
        if(!(cardName === filteredCards[x].name)) {
          cardsTemp.push(filteredCards[x]);
        }
      }
      filteredCards = cardsTemp;
      return false;
    };
    //adds plane to filteredPlane list
    function addPlane() {
      var cardIndex = parseInt(this.value);
      this.innerHTML = 'Remove';
      this.onclick = removePlane;
      this.classList.remove("btn-success");
      this.classList.add("btn-danger");
      filteredCards.push(cards[cardIndex]);
      return false;
    };
    </script>
  </body>
  </html>
